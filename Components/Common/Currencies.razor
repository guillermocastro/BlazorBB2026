@page "/Currencies"
@inject IStringLocalizer<Resources.Resource> L
@inject ICommonService CommonService
<h3>@L["Currencies"]</h3>
@if (currencyList == null)
{
    <img src="/img/loader2.gif" alt="Loading..." />
}
else
{
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-12">
                <ul class="pagination">
                    <li class="page-item"><a class="page-link" href="#">@L["CurrentPage"]</a></li>
                    <li class="page-item"><a class="page-link" href="#">@CurrentPage</a></li>
                    <li class="page-item"><a class="page-link" href="#">@L["TotalPages"]</a></li>
                    <li class="page-item"><a class="page-link" href="#">@TotalPages</a></li>
                    <li class="page-item"><a class="page-link" href="#">@L["TotalRows"]</a></li>
                    <li class="page-item"><a class="page-link" href="#">@TotalRows</a></li>
                    @if (CurrentPage > 1)
                    {
                        <li class="page-item"><button class="btn btn-primary" @onclick="FirstPage"><IconFirst /></button></li>
                    }
                    @if (CurrentPage > 1)
                    {
                        <li class="page-item"><button class="btn btn-primary" @onclick="PreviousPage"><IconPrevious /></button></li>
                    }
                    @if (CurrentPage < TotalPages)
                    {
                        <li class="page-item"><button class="btn btn-primary" @onclick="NextPage"><IconNext /></button></li>
                    }
                    @if (CurrentPage < TotalPages)
                    {
                        <li class="page-item"><button class="btn btn-primary" @onclick="LastPage"><IconLast /></button></li>
                    }
                </ul>
                <table class="table">
                    <thead>
                        <tr>
                            <th>
                                    <AuthorizeView  Roles="Accounting,Admin,Fiscal,Finance">
                                    <Authorized>
                                        <button class="btn btn-primary" @onclick="AddNewCurrency"><IconAdd /></button>
                                    </Authorized>
                                </AuthorizeView>
                            </th>
                            <th>@L["CurrencyId"]</th>
                            <th>@L["Currency3N"]</th>
                            <th>@L["CurrencyName"]</th>
                            <th>@L["LastValue"]</th>
                            <th>@L["IsEnabled"]</th>
                            <th><button class="btn btn-primary" @onclick="Refresh"><IconRefresh /></button></th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var currency in currencyList.Where(x => x.CurrencyId == currencyid || currencyid == ""))
                        {
                            <tr>
                                <td>
                                    <AuthorizeView  Roles="Accounting,Admin,Fiscal,Finance">
                                        <Authorized>
                                            <button class="btn btn-primary" @onclick="(() => EditCurrency(currency))"><IconUpdate /></button>
                                        </Authorized>
                                    </AuthorizeView>
                                </td>
                                <td>@currency.CurrencyId</td>
                                <td>@currency.Currency3N</td>
                                <td>@currency.CurrencyName</td>
                                <td>@currency.LastValue</td>
                                <td><input class="form-check-input" type="checkbox" id="IsEnabled" @bind="@currency.IsEnabled" disabled></td>
                                <td>&nbsp;</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    @if (ShowPopup)
    {
        <div class="modal" tabindex="-1" style="display:block" role="dialog">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        @if (IsNewRecord)
                        {
                            <h3 class="modal-title">@L["New"] @L["Currency"]</h3>
                        }
                        else
                        {
                            <h3 class="modal-title">@L["Edit"] @L["Currency"]</h3>
                        }
                        <!-- Button to close the popup -->
                        <button class="btn btn-dark"
                                @onclick="ClosePopup">
                            <IconCancel />
                        </button>
                    </div>
                    <!-- Edit form for the current reccord -->
                    <div class="modal-body">
                        <div class="form-floating">
                            <input class="form-control" id="ID" type="text" maxlength="3" placeholder="@L["ID"]" @bind="currency.CurrencyId" />
                            <label for="ID">@L["ID"]</label>
                        </div>
                        <div class="form-floating">
                            <input class="form-control" id="Currency3N" type="text" maxlength="3" placeholder="@L["Currency3N"]" @bind="currency.Currency3N" />
                            <label for="Currency3N">@L["Currency3N"]</label>
                        </div>
                        <div class="form-floating">
                            <input class="form-control" id="Name" type="text" placeholder="@L["Name"]" @bind="currency.CurrencyName" />
                            <label for="Name">@L["Name"]</label>
                        </div>
                        <div class="form-floating">
                            <input class="form-control" id="LastValue" type="number" placeholder="@L["LastValue"]" @bind="currency.LastValue" />
                            <label for="LastValue">@L["LastValue"]</label>
                        </div>
                        <div class="form-floating">
                            <div class="rz-p-12 rz-text-align-center">
                                <input class="form-check-input" type="checkbox" id="IsEnabled" @bind="currency.IsEnabled" />
                                <label for="IsEnabled">@L["IsEnabled"]</label>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-success"
                                @onclick="SaveCurrency">
                                <IconSave />
                        </button>
                        @if (IsNewRecord == false)
                        {
                            <button class="btn btn-danger"
                                    @onclick="DeleteCurrency">
                                <IconDelete />
                            </button>
                        }
                    </div>
                </div>
            </div>
        </div>
    }
}
@code {
    IEnumerable<Currency>? currencyList;
    private int _pageSize { get; set; } = 10;
    private int CurrentPage { get; set; } = 1;
    private int TotalPages { get; set; } = 0;
    private int TotalRows { get; set; } = 0;
    private bool HasNext { get; set; } = false;
    private bool HasPrevious { get; set; } = false;
    private string UserIdentityName = "";
    bool ShowPopup = false;
    bool ZoomIn = false;
    bool IsNewRecord = false;
    private string currencyid { get; set; } = "";
    Currency currency = new Currency();

    protected override async Task OnInitializedAsync()
    {
        await Refresh();
    }
    private async Task Refresh()
    {
        currencyList = await CommonService.GetCurrencies();
        if (currencyid == "")
        {
            TotalRows = currencyList.Count();
            TotalPages = (int)Math.Ceiling(TotalRows / (double)_pageSize);
            currencyList = currencyList.Skip((CurrentPage - 1) * _pageSize).Take(_pageSize).ToList();
        }
        if (CurrentPage > 1)
        {
            HasPrevious = true;
        }
        else
        {
            HasPrevious = false;
        }
        if (CurrentPage < TotalPages)
        {
            HasNext = true;
        }
        else
        {
            HasNext = false;
        }
    }
    void ClosePopup()
    {
        // Close the Popup
        ShowPopup = false;
    }
    void AddNewCurrency()
    {
        // Make new object
        currency = new Currency();

        currency.CurrencyId = "";
        currency.CurrencyName = "";
        currency.Currency3N = "";
        currency.LastValue = 1;
        currency.IsEnabled = true;

        ShowPopup = true;
        IsNewRecord = true;
        currencyid = "";
    }
    async Task SaveCurrency()
    {
        // Close the Popup
        ShowPopup = false;

        // A new forecast will have the Id set to 0
        if (IsNewRecord)
        {
            // Create new forecast
            Currency NewCurrency = new Currency();
            NewCurrency.CurrencyId = currency.CurrencyId;
            NewCurrency.CurrencyName = currency.CurrencyName;
            NewCurrency.LastValue = currency.LastValue;
            NewCurrency.Currency3N = currency.Currency3N;
            NewCurrency.IsEnabled = true;

            // Save the new row
            await CommonService.PostCurrency(NewCurrency);
            await Refresh();
        }
        else
        {
            // Update the row
            await CommonService.PutCurrency(currency);
            currencyid = "";
        }
        await Refresh();
    }
    void EditCurrency(Currency existingCurrency)
    {
        currency = existingCurrency;
        ShowPopup = true;
        IsNewRecord = false;
    }
    async Task DeleteCurrency()
    {
        ShowPopup = false;

        await CommonService.DeleteCurrency(currency);
        currencyid = "";
        await Refresh();
    }
    private async Task FirstPage()
    {
        CurrentPage = 1;
        await Refresh();
    }
    private async Task LastPage()
    {
        CurrentPage = TotalPages;
        await Refresh();
    }
    private async Task NextPage()
    {
        if (HasNext)
        {
            CurrentPage = CurrentPage + 1;
            await Refresh();
        }
    }
    private async Task PreviousPage()
    {
        if (HasPrevious)
        {
            CurrentPage = CurrentPage - 1;
            await Refresh();
        }
    }
}
